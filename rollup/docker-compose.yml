# ============================================================================
# QRMS OP Stack L2 Rollup - Docker Compose
# Based on: opstack/docs/create-l2-rollup-example
# ============================================================================

services:
  # ==========================================================================
  # QRMS Services (Rust)
  # ==========================================================================
  
  qrms:
    build:
      context: ../qrms-rust
      dockerfile: ../rollup/docker/Dockerfile.qrms
    container_name: qrms
    restart: unless-stopped
    ports:
      - "5050:5050"   # REST API + WebSocket
      - "9090:9090"   # gRPC
    environment:
      - RUST_LOG=info
      - QRM_RISK_THRESHOLD_SCHEDULED=6000
      - QRM_RISK_THRESHOLD_EMERGENCY=9000
      - L2_RPC_URL=http://op-geth:8545
    volumes:
      - qrms_data:/data
    networks:
      - qrms-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/api/status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # OP Stack: Sequencer (op-geth + op-node)
  # ==========================================================================
  
  op-geth:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:v1.101511.1
    container_name: op-geth
    volumes:
      - ./sequencer:/workspace
      - op_geth_data:/workspace/op-geth-data
    working_dir: /workspace
    env_file:
      - .env
    ports:
      - "8545:8545"   # HTTP RPC
      - "8546:8546"   # WebSocket
      - "8551:8551"   # Engine API
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        if [ ! -d /workspace/op-geth-data/geth/chaindata ]; then
          echo "Initializing geth datadir..."
          geth init --datadir=/workspace/op-geth-data --state.scheme=hash /workspace/genesis.json
        fi
        echo "Starting geth..."
        exec geth \
          --datadir=/workspace/op-geth-data \
          --http --http.addr=0.0.0.0 --http.port=8545 \
          --ws --ws.addr=0.0.0.0 --ws.port=8546 \
          --authrpc.addr=0.0.0.0 --authrpc.port=8551 \
          --authrpc.jwtsecret=/workspace/jwt.txt \
          --syncmode=full --gcmode=archive \
          --rollup.disabletxpoolgossip=true \
          --http.vhosts=* --http.corsdomain=* \
          --http.api=eth,net,web3,debug,txpool,admin \
          --ws.origins=* --ws.api=eth,net,web3,debug,txpool,admin \
          --authrpc.vhosts=*
    networks:
      - qrms-net

  op-node:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-node:v1.13.5
    container_name: op-node
    volumes:
      - ./sequencer:/workspace
      - op_geth_data:/workspace/op-geth-data
    working_dir: /workspace
    env_file:
      - .env
    ports:
      - "8547:8547"   # RPC
      - "9222:9222"   # P2P
    command: >
      op-node
      --l1=${L1_RPC_URL}
      --l1.beacon=${L1_BEACON_URL}
      --l2=http://op-geth:8551
      --l2.jwt-secret=/workspace/jwt.txt
      --rollup.config=/workspace/rollup.json
      --sequencer.enabled=true
      --sequencer.stopped=false
      --sequencer.max-safe-lag=3600
      --verifier.l1-confs=4
      --p2p.disable
      --rpc.addr=0.0.0.0
      --rpc.port=8547
      --rpc.enable-admin
      --log.level=info
      --log.format=json
    depends_on:
      - op-geth
    networks:
      - qrms-net
    healthcheck:
      test: ["CMD", "wget", "--post-data={\"jsonrpc\":\"2.0\",\"method\":\"optimism_syncStatus\",\"params\":[],\"id\":1}", "--header=Content-Type: application/json", "--quiet", "--tries=1", "--timeout=10", "--output-document=-", "http://localhost:8547"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # OP Stack: Batcher
  # ==========================================================================
  
  batcher:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-batcher:v1.14.0
    container_name: op-batcher
    profiles: ["infra"]
    volumes:
      - ./batcher:/workspace
    working_dir: /workspace
    env_file:
      - .env
    environment:
      - OP_BATCHER_L1_ETH_RPC=${L1_RPC_URL}
      - OP_BATCHER_PRIVATE_KEY=${PRIVATE_KEY}
    command: >
      op-batcher
      --rpc.addr=0.0.0.0
      --rpc.port=8548
      --rpc.enable-admin
      --max-channel-duration=1
      --data-availability-type=calldata
      --resubmission-timeout=30s
      --log.level=info
      --log.format=json
    depends_on:
      op-node:
        condition: service_healthy
    networks:
      - qrms-net

  # ==========================================================================
  # OP Stack: Proposer
  # ==========================================================================
  
  proposer:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-proposer:v1.10.0
    container_name: op-proposer
    profiles: ["infra"]
    volumes:
      - ./proposer:/workspace
    working_dir: /workspace
    env_file:
      - .env
    environment:
      - OP_PROPOSER_L1_ETH_RPC=${L1_RPC_URL}
      - OP_PROPOSER_PRIVATE_KEY=${PRIVATE_KEY}
    command: >
      op-proposer
      --rpc.port=8560
      --rollup-rpc=http://op-node:8547
      --allow-non-finalized=true
      --wait-node-sync=true
      --log.level=info
      --log.format=json
    depends_on:
      op-node:
        condition: service_healthy
    networks:
      - qrms-net

  # ==========================================================================
  # OP Stack: Challenger
  # ==========================================================================
  
  challenger:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-challenger:v1.5.1
    container_name: op-challenger
    profiles: ["infra"]
    volumes:
      - ./challenger:/workspace
    working_dir: /workspace
    env_file:
      - .env
    environment:
      - OP_CHALLENGER_L1_ETH_RPC=${L1_RPC_URL}
      - OP_CHALLENGER_L1_BEACON=${L1_BEACON_URL}
      - OP_CHALLENGER_PRIVATE_KEY=${PRIVATE_KEY}
    command: >
      op-challenger run-trace
      --trace-type=cannon
      --cannon-l2-genesis=/workspace/genesis.json
      --cannon-rollup-config=/workspace/rollup.json
      --l2-eth-rpc=http://op-geth:8545
      --rollup-rpc=http://op-node:8547
      --datadir=/workspace/data
      --log.level=info
      --log.format=json
    depends_on:
      op-node:
        condition: service_healthy
    networks:
      - qrms-net

  # ==========================================================================
  # OP Stack: Dispute Monitor
  # ==========================================================================
  
  dispute-mon:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-dispute-mon:v1.4.2-rc.1
    container_name: dispute-mon
    profiles: ["infra"]
    volumes:
      - ./dispute-mon:/workspace
    working_dir: /workspace
    ports:
      - "7300:7300"
    env_file:
      - .env
    environment:
      - OP_DISPUTE_MON_L1_ETH_RPC=${L1_RPC_URL}
      - OP_DISPUTE_MON_ROLLUP_RPC=http://op-node:8547
      - OP_DISPUTE_MON_MONITOR_INTERVAL=10s
      - OP_DISPUTE_MON_NETWORK=op-sepolia
      - OP_DISPUTE_MON_LOG_LEVEL=debug
      - OP_DISPUTE_MON_LOG_FORMAT=logfmt
      - OP_DISPUTE_MON_METRICS_ADDR=0.0.0.0
      - OP_DISPUTE_MON_METRICS_ENABLED=true
      - OP_DISPUTE_MON_METRICS_PORT=7300
    depends_on:
      op-node:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - qrms-net

volumes:
  op_geth_data:
  qrms_data:

networks:
  qrms-net:
    driver: bridge
